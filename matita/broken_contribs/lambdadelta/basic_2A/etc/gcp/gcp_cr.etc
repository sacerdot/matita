(**************************************************************************)
(*       ___                                                              *)
(*      ||M||                                                             *)
(*      ||A||       A project by Andrea Asperti                           *)
(*      ||T||                                                             *)
(*      ||I||       Developers:                                           *)
(*      ||T||         The HELM team.                                      *)
(*      ||A||         http://helm.cs.unibo.it                             *)
(*      \   /                                                             *)
(*       \ /        This file is distributed under the terms of the       *)
(*        v         GNU General Public License Version 2                  *)
(*                                                                        *)
(**************************************************************************)

include "basic_2/notation/relations/ineint_5.ma".
include "basic_2/grammar/aarity.ma".
include "basic_2/multiple/mr2_mr2.ma".
include "basic_2/multiple/lifts_lift_vector.ma".
include "basic_2/multiple/drops_drop.ma".
include "basic_2/computation/gcp.ma".

(* GENERIC COMPUTATION PROPERTIES *******************************************)

definition S0 â‰ Î»C:candidate. âˆ€G,L2,L1,T1,d,e.
                C G L1 T1 â†’ âˆ€T2. â‡©[â’», d, e] L2 â‰¡ L1 â†’ â‡§[d, e] T1 â‰¡ T2 â†’ C G L2 T2.

definition S0s â‰ Î»C:candidate.
                 âˆ€G,L1,L2,des. â‡©*[â’», des] L2 â‰¡ L1 â†’
                 âˆ€T1,T2. â‡§*[des] T1 â‰¡ T2 â†’ C G L1 T1 â†’ C G L2 T2.

(* Note: this is Girard's CR1 *)
definition S1 â‰ Î»RP,C:candidate.
                âˆ€G,L,T. C G L T â†’ RP G L T.

(* Note: this is Tait's iii, or Girard's CR4 *)
definition S2 â‰ Î»RR:relation4 genv lenv term term. Î»RS:relation term. Î»RP,C:candidate.
                âˆ€G,L,Vs. all â€¦ (RP G L) Vs â†’
                âˆ€T. ğ’â¦ƒTâ¦„ â†’ NF â€¦ (RR G L) RS T â†’ C G L (â’¶Vs.T).

(* Note: this generalizes Tait's ii *)
definition S3 â‰ Î»C:candidate.
                âˆ€a,G,L,Vs,V,T,W.
                C G L (â’¶Vs.â““{a}â“W.V.T) â†’ C G L (â’¶Vs.â“V.â“›{a}W.T).

definition S4 â‰ Î»RP,C:candidate.
                âˆ€G,L,Vs. all â€¦ (RP G L) Vs â†’ âˆ€k. C G L (â’¶Vs.â‹†k).

definition S5 â‰ Î»C:candidate. âˆ€I,G,L,K,Vs,V1,V2,i.
                â‡©[i] L â‰¡ K.â“‘{I}V1 â†’ â‡§[0, i+1] V1 â‰¡ V2 â†’
                C G L (â’¶Vs.V2) â†’ C G L (â’¶Vs.#i).

definition S6 â‰ Î»RP,C:candidate.
                âˆ€G,L,V1s,V2s. â‡§[0, 1] V1s â‰¡ V2s â†’
                âˆ€a,V,T. C G (L.â““V) (â’¶V2s.T) â†’ RP G L V â†’ C G L (â’¶V1s.â““{a}V.T).

definition S7 â‰ Î»C:candidate.
                âˆ€G,L,Vs,T,W. C G L (â’¶Vs.T) â†’ C G L (â’¶Vs.W) â†’ C G L (â’¶Vs.â“W.T).

(* requirements for the generic reducibility candidate *)
record gcr (RR:relation4 genv lenv term term) (RS:relation term) (RP,C:candidate) : Prop â‰
{ (* s0: S0 C; *)
  s1: S1 RP C;
  s2: S2 RR RS RP C;
  s3: S3 C;
  s4: S4 RP C;
  s5: S5 C;
  s6: S6 RP C;
  s7: S7 C
}.

(* the functional construction for candidates *)
definition cfun: candidate â†’ candidate â†’ candidate â‰
                 Î»C1,C2,G,K,T. âˆ€V. C1 G K V â†’ C2 G K (â“V.T).

(* the reducibility candidate associated to an atomic arity *)
let rec acr (RP:candidate) (A:aarity) on A: candidate â‰
match A with
[ AAtom     â‡’ RP
| APair B A â‡’ cfun (acr RP B) (acr RP A)
].

interpretation
   "candidate of reducibility of an atomic arity (abstract)"
   'InEInt RP G L T A = (acr RP A G L T).

(* Basic properties *********************************************************)
(*
(* Basic_1: was: sc3_lift1 *)
lemma gcr_lifts: âˆ€C. S0 C â†’ S0s C.
#C #HC #G #L1 #L2 #des #H elim H -L1 -L2 -des
[ #L #T1 #T2 #H #HT1 <(lifts_inv_nil â€¦ H) -H //
| #L1 #L #L2 #des #d #e #_ #HL2 #IHL #T2 #T1 #H #HLT2
  elim (lifts_inv_cons â€¦ H) -H /3 width=10 by/
]
qed.
*)
axiom rp_lift: âˆ€RP. S0 RP.


axiom rp_lifts: âˆ€RR,RS,RP. gcr RR RS RP RP â†’
                âˆ€des,G,L0,L,V,V0. â‡©*[â’», des] L0 â‰¡ L â†’ â‡§*[des] V â‰¡ V0 â†’
                RP G L V â†’ RP G L0 V0.
(*
#RR #RS #RP #HRP #des #G #L0 #L #V #V0 #HL0 #HV0 #HV
@gcr_lifts /width=7 by/
@(s0 â€¦ HRP)
qed.
*)
(* Basic_1: was only: sns3_lifts1 *)
axiom rp_liftsv_all: âˆ€RR,RS,RP. gcr RR RS RP RP â†’
                     âˆ€des,G,L0,L,Vs,V0s. â‡©*[â’», des] L0 â‰¡ L â†’ â‡§*[des] Vs â‰¡ V0s â†’
                     all â€¦ (RP G L) Vs â†’ all â€¦ (RP G L0) V0s.
(*
#RR #RS #RP #HRP #des #G #L0 #L #Vs #V0s #HL0 #H elim H -Vs -V0s normalize //
#T1s #T2s #T1 #T2 #HT12 #_ #IHT2s * /3 width=7 by rp_lifts, conj/
qed.
*)

lemma gcr_lift: âˆ€RR,RS,RP. gcp RR RS RP â†’ gcr RR RS RP RP â†’
                âˆ€A. S0 (acr RP A).
#RR #RS #RP #H1RP #H2RP #A elim A -A /2 width=7 by rp_lift/
#B #A #IHB #IHA #G #L2 #L1 #T1 #d #e #IH #T2 #HL21 #HT12 #V #HB
@(IHA â€¦ HL21) [3: @(lift_flat â€¦ HT12) |1: skip |  

(* Basic_1: was:
   sc3_sn3 sc3_abst sc3_appl sc3_abbr sc3_bind sc3_cast sc3_lift
*)
lemma acr_gcr: âˆ€RR,RS,RP. gcp RR RS RP â†’ gcr RR RS RP RP â†’
               âˆ€A. gcr RR RS RP (acr RP A).
#RR #RS #RP #H1RP #H2RP #A elim A -A //
#B #A #IHB #IHA @mk_gcr
[ #G #L #T #H
  elim (cp1 â€¦ H1RP G L) #k #HK
  lapply (H (â‹†k) ?) -H
  [ lapply (s2 â€¦ IHB G L (â—Š) â€¦ HK) //
  | #H @(cp2 â€¦ H1RP â€¦ k) @(s1 â€¦ IHA) //
  ]
| #G #L #Vs #HVs #T #H1T #H2T #V #HB
  lapply (s1 â€¦ IHB â€¦ HB) #HV
  @(s2 â€¦ IHA â€¦ (V @ Vs))
  /3 width=14 by rp_liftsv_all, gcp_lifts, cp0, lifts_simple_dx, conj/
| #a #G #L #Vs #U #T #W #HA #V #HB
  @(s3 â€¦ IHA â€¦ (V @ Vs)) /2 width=1 by/
| #G #L #Vs #HVs #k #V #HB
  lapply (s1 â€¦ IHB â€¦ HB) #HV
  @(s4 â€¦ IHA â€¦ (V @ Vs)) /3 width=7 by rp_liftsv_all, conj/
| #I #G #L #K #Vs #V1 #V2 #i #HLK #HV12 #HA #V #HB
  @(s5 â€¦ IHA â€¦ (V @ Vs) â€¦ HLK HV12) /2 width=1 by/
| #G #L #V1s #V2s #HV12s #a #W #T #HA #HW #V1 #HB
  elim (lift_total V1 0 1) #V2 #HV12
  @(s6 â€¦ IHA â€¦ (V1 @ V1s) (V2 @ V2s)) /2 width=1 by liftv_cons/
  @HA @(gcr_lift â€¦ H1RP H2RP â€¦ HB â€¦ HV12) /2 width=2 by drop_drop/
| #G #L #Vs #T #W #HA #HW #V #HB
  @(s7 â€¦ IHA â€¦ (V @ Vs)) /2 width=1 by/
]
qed.

lemma acr_abst: âˆ€RR,RS,RP. gcp RR RS RP â†’ gcr RR RS RP RP â†’
                âˆ€a,G,L,W,T,B,A. â¦ƒG, L, Wâ¦„ Ïµ[RP] ã€šBã€› â†’ (
                   âˆ€V. â¦ƒG, L, Vâ¦„ Ïµ[RP] ã€šBã€› â†’ â¦ƒG, L.â““â“W.V, Tâ¦„ Ïµ[RP] ã€šAã€›
                ) â†’
                â¦ƒG, L, â“›{a}W.Tâ¦„ Ïµ[RP] ã€šâ‘¡B.Aã€›.
#RR #RS #RP #H1RP #H2RP #a #G #L #W #T #B #A #HW #HA #L0 #V0 #X #des #HL0 #H #HB
lapply (acr_gcr â€¦ H1RP H2RP A) #HCA
lapply (acr_gcr â€¦ H1RP H2RP B) #HCB
elim (lifts_inv_bind1 â€¦ H) -H #W0 #T0 #HW0 #HT0 #H destruct
lapply (gcr_lifts â€¦ HL0 â€¦ HW0 HW) -HW [ @(s0 â€¦ HCB) ] #HW0
lapply (s3 â€¦ HCA â€¦ a G L0 (â—Š)) #H @H -H
lapply (s6 â€¦ HCA G L0 (â—Š) (â—Š) ?) // #H @H -H
[ @(HA â€¦ HL0) //
| lapply (s1 â€¦ HCB) -HCB #HCB
  lapply (s7 â€¦ H2RP G L0 (â—Š)) /3 width=1 by/
]
qed.

(* Basic_1: removed theorems 2: sc3_arity_gen sc3_repl *)
(* Basic_1: removed local theorems 1: sc3_sn3_abst *)
