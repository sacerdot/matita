include "delayed_updating/notation/functions/nodelabel_d_2.ma".

| label_d2: pnat â†’ nat â†’ label

interpretation
  "variable reference by depth with offset (label)"
  'NodeLabelD k d = (label_d2 k d).

  | label_d2 k d â‡’ depth q

lemma depth_d2_dx (p) (k) (d):
      â™­p = â™­(pâ—–ğ—±â¨k,dâ©).
// qed.

lemma depth_d2_sn (p) (k) (d):
      â™­p = â™­(ğ—±â¨k,dâ©â——p).
// qed.

   | label_d2 k d â‡’ structure q

lemma structure_d2_dx (p) (k) (d):
      âŠ—p = âŠ—(pâ—–ğ—±â¨k,dâ©).
// qed.

lemma structure_d2_sn (p) (k) (d):
      âŠ—p = âŠ—(ğ—±â¨k,dâ©â——p).
#p #k #d <structure_append //
qed.

lemma eq_inv_d2_dx_structure (d) (h) (q) (p):
      qâ—–ğ—±â¨h,dâ© = âŠ—p â†’ âŠ¥.
#d #h #q #p elim p -p [| * [ #k | #k #d ] #p #IH ]
[ <structure_empty #H0 destruct
| <structure_d_dx #H0 /2 width=1 by/
| <structure_d2_dx #H0 /2 width=1 by/
| <structure_m_dx #H0 /2 width=1 by/
| <structure_L_dx #H0 destruct
| <structure_A_dx #H0 destruct
| <structure_S_dx #H0 destruct
]
qed-.

lemma eq_inv_d2_sn_structure (d) (h) (q) (p):
      (ğ—±â¨h,dâ©â——q) = âŠ—p â†’ âŠ¥.
#d #h #q #p >list_cons_comm #H0
elim (eq_inv_append_structure â€¦ H0) -H0 #r1 #r2
<list_cons_comm #H0 #H1 #H2 destruct
elim (eq_inv_d2_dx_structure â€¦ H0)
qed-.

include "delayed_updating/notation/functions/tau_3.ma".

interpretation
  "inner variable reference by depth with offset (prototerm)"
  'Tau k d t = (prototerm_node_1_2 (label_d2 k d) label_m t).

lemma in_comp_iref2 (t) (q) (k) (d):
      q Ïµ t â†’ ğ—±â¨k,dâ©â——ğ—ºâ——q Ïµ ğ›•â¨k,dâ©.t.
/2 width=3 by ex2_intro/ qed.

lemma in_comp_inv_iref2 (t) (p) (k) (d):
      p Ïµ ğ›•â¨k,dâ©.t â†’
      âˆƒâˆƒq. ğ—±â¨k,dâ©â——ğ—ºâ——q = p & q Ïµ t.
#t #p #k #d * #q #Hq #Hp
/2 width=3 by ex2_intro/
qed-.

lemma ppc_iref2 (t) (k) (d):
      (ğ›•â¨k,dâ©.t) Ïµ ğ.
#t #k #d #p * #q #Hq #H0 destruct //
qed.

lemma pic_inv_d2_dx (p) (k) (d):
      pâ—–ğ—±â¨k,dâ© Ïµ ğˆ â†’ âŠ¥.
#p #k #d @(insert_eq_1 â€¦ (pâ—–ğ—±â¨k,dâ©))
#q * -q [|*: #q ] #H0 destruct
qed-.
