(**************************************************************************)
(*       ___                                                              *)
(*      ||M||                                                             *)
(*      ||A||       A project by Andrea Asperti                           *)
(*      ||T||                                                             *)
(*      ||I||       Developers:                                           *)
(*      ||T||         The HELM team.                                      *)
(*      ||A||         http://helm.cs.unibo.it                             *)
(*      \   /                                                             *)
(*       \ /        This file is distributed under the terms of the       *)
(*        v         GNU General Public License Version 2                  *)
(*                                                                        *)
(**************************************************************************)

include "delayed_updating/unwind/unwind2_rmap_closed.ma".
include "delayed_updating/unwind/unwind2_rmap_guard.ma".

(* TAILED UNWIND FOR RELOCATION MAP *****************************************)

(* Crucial constructions with tr_uni ****************************************)

f : (ğ”½ğ”¹)
 t1 : prototerm
 H0t1 : (t1Ïµğ“)
 p : (list label)
 b : (list label)
 q : (list label)
 n : â„•
 Hb : (âŠ—bÏµğ)
 Hn : (qÏµğ‚â¨nâ©)
 ---------------------------
  
 (ğ®â¨â¤â†‘(â™­âŠ—b+â™­q)â©â€¢â–¶[p]fâ‰â®¤*[â¤â†‘(â™­b+n)]â–¶[ğ—Ÿâ——q]â–¶[â“ªb]â–¶[pâ—–ğ—”]f)

(* Note: crux of the commutation between unwind and balanced focused reduction *)
lemma unwind2_rmap_uni_crux (f) (p) (b) (q) (m) (n):
      p Ïµ ğ† â†’ b Ïµ ğ‚â¨â’»,mâ© â†’ q Ïµ ğ‚â¨â’»,nâ© â†’
      (ğ®â¨â†‘(â™­b+â™­q)â© âˆ˜ â–¶[â«¯f]p â‰— â–¶[â«¯f](pâ—ğ—”â——bâ—ğ—Ÿâ——q) âˆ˜ ğ®â¨â†‘(m+n)â©).
#f #p #b #q #m #n #Hp #Hm #Hn
<list_append_rcons_sn <list_append_rcons_sn >list_append_assoc
>list_append_rcons_sn >(list_append_rcons_sn â€¦ b)
@(stream_eq_trans â€¦ (tr_compose_uni_dx_pap â€¦)) <tr_pap_succ_nap
@(stream_eq_trans ????? (tr_compose_eq_repl â€¦))
[| @tls_succ_plus_unwind2_rmap_append_closed_Lq_dx // | skip
|  <nap_plus_unwind2_rmap_append_closed_Lq_dx // | skip
] -Hn
@tr_eq_inv_nap_zero_tl_bi
[ <tr_compose_nap <tr_compose_nap <tr_uni_nap <tr_uni_nap
  <nap_zero_unwind2_rmap_push_guard // <nplus_zero_sn
  >nsucc_unfold >nplus_succ_dx >nplus_succ_dx <nplus_assoc
  >tr_nap_plus_dx <unwind2_rmap_append
  <nap_plus_unwind2_rmap_closed [|*: /2 width=2 by pcc_A_sn/ ]
  <nap_zero_unwind2_rmap_push_guard //
| @(stream_eq_canc_sn â€¦ (tr_tl_compose_uni_sn â€¦))
  @(stream_eq_trans ????? (tr_tl_compose_uni_sn â€¦))
  >stream_tls_succ <unwind2_rmap_append <unwind2_rmap_push_guard
  /2 width=2 by tls_succ_plus_unwind2_rmap_push_closed/
]
qed-.
