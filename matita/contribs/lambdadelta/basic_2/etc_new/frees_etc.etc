(**************************************************************************)
(*       ___                                                              *)
(*      ||M||                                                             *)
(*      ||A||       A project by Andrea Asperti                           *)
(*      ||T||                                                             *)
(*      ||I||       Developers:                                           *)
(*      ||T||         The HELM team.                                      *)
(*      ||A||         http://helm.cs.unibo.it                             *)
(*      \   /                                                             *)
(*       \ /        This file is distributed under the terms of the       *)
(*        v         GNU General Public License Version 2                  *)
(*                                                                        *)
(**************************************************************************)

include "basic_2/relocation/drops_weight.ma".
include "basic_2/s_computation/fqup_weight.ma".
include "basic_2/s_computation/fqus_fqup.ma".
include "basic_2/static/frees.ma".

corec lemma sle_refl: âˆ€f. f âŠ† f.
#f cases (pn_split f) * #g #H
[ @(sle_push â€¦ H H) | @(sle_next â€¦ H H) ] -H //
qed.

lemma sle_inv_tl1: âˆ€f1,f2. â«±f1 âŠ† f2 â†’ f1 âŠ† â«¯f2.
#f1 elim (pn_split f1) * #g #H destruct
/2 width=5 by sle_next, sle_weak/
qed-.

axiom sor_tls: âˆ€f1,f2,f. f1 â‹“ f2 â‰¡ f â†’
               âˆ€n. â«±*[n]f1 â‹“ â«±*[n]f2 â‰¡ â«±*[n]f.

axiom sor_sle1: âˆ€f1,f2,f. f1 â‹“ f2 â‰¡ f â†’
                âˆ€g. g âŠ† f1 â†’ g âŠ† f.

axiom sor_sle2: âˆ€f1,f2,f. f1 â‹“ f2 â‰¡ f â†’
                âˆ€g. g âŠ† f2 â†’ g âŠ† f.

lemma fqus_inv_refl_atom3: âˆ€I,G,L,X. â¦ƒG, L, â“ª{I}â¦„ âŠ* â¦ƒG, L, Xâ¦„ â†’ â“ª{I} = X.
#I #G #L #X #H elim (fqus_inv_fqup â€¦ H) -H [2: * // ]
#H lapply (fqup_fwd_fw â€¦ H) -H
#H elim (lt_le_false â€¦ H) -H /2 width=1 by monotonic_le_plus_r/
qed-.  

axiom drops_T_isuni_inv_refl: âˆ€n,L. â¬‡*[n] L â‰¡ L â†’ n = 0.

axiom fqus_split_fqu: âˆ€G1,G2,L1,L2,T1,T2. â¦ƒG1, L1, T1â¦„ âŠ* â¦ƒG2, L2, T2â¦„ â†’
                      (âˆ§âˆ§ G1 = G2 & L1 = L2 & T1 = T2) âˆ¨
                      âˆƒâˆƒG,L,T. â¦ƒG1, L1, T1â¦„ âŠ â¦ƒG, L, Tâ¦„ & â¦ƒG, L, Tâ¦„ âŠ* â¦ƒG2, L2, T2â¦„.

axiom fqus_inv_atom1: âˆ€I,G1,G2,L2,T2. â¦ƒG1, â‹†, â“ª{I}â¦„ âŠ* â¦ƒG2, L2, T2â¦„ â†’
                      âˆ§âˆ§ G1 = G2 & â‹† = L2 & â“ª{I} = T2.

axiom fqus_inv_sort1: âˆ€G1,G2,L1,L2,T2,s. â¦ƒG1, L1, â‹†sâ¦„ âŠ* â¦ƒG2, L2, T2â¦„ â†’
                      âˆ§âˆ§ G1 = G2 & L1 = L2 & â‹†s = T2.

axiom fqus_inv_zero1: âˆ€I,G1,G2,L1,L2,V1,T2. â¦ƒG1, L1.â“‘{I}V1, #0â¦„ âŠ* â¦ƒG2, L2, T2â¦„ â†’
                      (âˆ§âˆ§ G1 = G2 & L1.â“‘{I}V1 = L2 & #0 = T2) âˆ¨ â¦ƒG1, L1, V1â¦„ âŠ* â¦ƒG2, L2, T2â¦„.

axiom fqus_inv_lref1: âˆ€I,G1,G2,L1,L2,V1,T2,i. â¦ƒG1, L1.â“‘{I}V1, #â«¯iâ¦„ âŠ* â¦ƒG2, L2, T2â¦„ â†’
                      (âˆ§âˆ§ G1 = G2 & L1.â“‘{I}V1 = L2 & #(â«¯i) = T2) âˆ¨ â¦ƒG1, L1, #iâ¦„ âŠ* â¦ƒG2, L2, T2â¦„.

axiom fqus_inv_gref1: âˆ€G1,G2,L1,L2,T2,l. â¦ƒG1, L1, Â§lâ¦„ âŠ* â¦ƒG2, L2, T2â¦„ â†’
                      âˆ§âˆ§ G1 = G2 & L1 = L2 & Â§l = T2.

axiom fqus_inv_bind1: âˆ€p,I,G1,G2,L1,L2,V1,T1,T2. â¦ƒG1, L1, â“‘{p,I}V1.T1â¦„ âŠ* â¦ƒG2, L2, T2â¦„ â†’
                      âˆ¨âˆ¨ âˆ§âˆ§ G1 = G2 & L1 = L2 & â“‘{p,I}V1.T1 = T2 
                       | â¦ƒG1, L1, V1â¦„ âŠ* â¦ƒG2, L2, T2â¦„
                       | â¦ƒG1, L1.â“‘{I}V1, T1â¦„ âŠ* â¦ƒG2, L2, T2â¦„.

axiom fqus_inv_flat1: âˆ€I,G1,G2,L1,L2,V1,T1,T2. â¦ƒG1, L1, â“•{I}V1.T1â¦„ âŠ* â¦ƒG2, L2, T2â¦„ â†’
                      âˆ¨âˆ¨ âˆ§âˆ§ G1 = G2 & L1 = L2 & â“•{I}V1.T1 = T2 
                       | â¦ƒG1, L1, V1â¦„ âŠ* â¦ƒG2, L2, T2â¦„
                       | â¦ƒG1, L1, T1â¦„ âŠ* â¦ƒG2, L2, T2â¦„.

(* CONTEXT-SENSITIVE FREE VARIABLES *****************************************)

lemma frees_drops_sle: âˆ€f1,G,L1,T1. L1 âŠ¢ ğ…*â¦ƒT1â¦„ â‰¡ f1 â†’
                       âˆ€L2,T2. â¦ƒG, L1, T1â¦„ âŠ* â¦ƒG, L2, T2â¦„ â†’
                       âˆ€I,n. â¬‡*[n] L1 â‰¡ L2.â“‘{I}T2 â†’
                       âˆƒâˆƒf2. L2 âŠ¢ ğ…*â¦ƒT2â¦„ â‰¡ f2 & f2 âŠ† â«±*[â«¯n] f1.
#f1 #G #L1 #T1 #H elim H -f1 -L1 -T1
[ #f1 #J #Hf1 #L2 #T2 #H12 #I #n #HL12
  elim (fqus_inv_atom1 â€¦ H12) -H12 #H1 #H2 #H3 destruct
  lapply (drops_fwd_lw â€¦ HL12) -HL12 #HL12
  elim (lt_le_false â€¦ HL12) -HL12 //
| #f1 #J #L1 #V1 #s #_ #_ #L2 #T2 #H12 #I #n #HL12
  elim (fqus_inv_sort1 â€¦ H12) -H12 #H1 #H2 #H3 destruct
  lapply (drops_fwd_lw â€¦ HL12) -HL12 #HL12
  elim (lt_le_false â€¦ HL12) -HL12 //
| #f1 #J #L1 #V1 #Hf1 #IH #L2 #T2 #H12
  elim (fqus_inv_zero1 â€¦ H12) -H12 [ * | #H12 #I * ]
  [ -IH -Hf1 #H1 #H2 #H3 #I #n #HL12 destruct
    lapply (drops_fwd_lw â€¦ HL12) -HL12 #HL12
    elim (lt_le_false â€¦ HL12) -HL12 //
  | -IH -H12 #HL12 lapply (drops_fwd_isid â€¦ HL12 ?) -HL12 //
     #H destruct /3 width=3 by sle_refl, ex2_intro/
  | -Hf1 #n #HL12 lapply (drops_inv_drop1 â€¦ HL12) -HL12
    #HL12 elim (IH â€¦ H12 â€¦ HL12) -IH -H12 -HL12 /3 width=3 by ex2_intro/
  ]
| #f1 #J #L1 #V1 #i #Hf1 #IH #L2 #T2 #H12
  elim (fqus_inv_lref1 â€¦ H12) -H12 [ * | #H12 #I * ]
  [ -IH -Hf1 #H1 #H2 #H3 #I #n #HL12 destruct
    lapply (drops_fwd_lw â€¦ HL12) -HL12 #HL12
    elim (lt_le_false â€¦ HL12) -HL12 //
  | -IH #HL12 lapply (drops_fwd_isid â€¦ HL12 ?) -HL12 //
    #H destruct <(fqus_inv_refl_atom3 â€¦ H12) -H12 /2 width=3 by sle_refl, ex2_intro/
  | -Hf1 #I #HL12 lapply (drops_inv_drop1 â€¦ HL12) -HL12
    #HL12 elim (IH â€¦ H12 â€¦ HL12) -IH -H12 -HL12 /3 width=3 by ex2_intro/
  ]
| #f1 #J #L1 #V1 #l #_ #_ #L2 #T2 #H12 #I #n #HL12
  elim (fqus_inv_gref1 â€¦ H12) -H12 #H1 #H2 #H3 destruct
  lapply (drops_fwd_lw â€¦ HL12) -HL12 #HL12
  elim (lt_le_false â€¦ HL12) -HL12 //
| #f1V #f1T #f1 #p #J #L1 #V #T #_ #_ #Hf1 #IHV #IHT #L2 #T2 #H12 #I #n #HL12
  elim (fqus_inv_bind1 â€¦ H12) -H12 [ * |*: #H12 ]
  [ -IHV -IHT -Hf1 #H1 #H2 #H3 destruct
    lapply (drops_fwd_lw â€¦ HL12) -HL12 #HL12
    elim (lt_le_false â€¦ HL12) -HL12 //
  | -IHT elim (IHV â€¦ H12 â€¦ HL12) -IHV -H12 -HL12
    /4 width=6 by sor_tls, sor_sle1, ex2_intro/
  | -IHV elim (IHT â€¦ H12 I (â«¯n)) -IHT -H12 /2 width=1 by drops_drop/ -HL12
    <tls_xn /4 width=6 by ex2_intro, sor_tls, sor_sle2/
  ]
| #f1V #f1T #f1 #J #L1 #V #T #_ #_ #Hf1 #IHV #IHT #L2 #T2 #H12 #I #n #HL12
  elim (fqus_inv_flat1 â€¦ H12) -H12 [ * |*: #H12 ]
  [ -IHV -IHT -Hf1 #H1 #H2 #H3 destruct
    lapply (drops_fwd_lw â€¦ HL12) -HL12 #HL12
    elim (lt_le_false â€¦ HL12) -HL12 //
  | -IHT elim (IHV â€¦ H12 â€¦ HL12) -IHV -H12 -HL12
    /4 width=6 by sor_tls, sor_sle1, ex2_intro/
  | -IHV elim (IHT â€¦ H12 â€¦ HL12) -IHT -H12 -HL12
    /4 width=6 by ex2_intro, sor_tls, sor_sle2/
  ]
]
qed-.
