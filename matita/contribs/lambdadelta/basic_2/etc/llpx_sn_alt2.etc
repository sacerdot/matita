(**************************************************************************)
(*       ___                                                              *)
(*      ||M||                                                             *)
(*      ||A||       A project by Andrea Asperti                           *)
(*      ||T||                                                             *)
(*      ||I||       Developers:                                           *)
(*      ||T||         The HELM team.                                      *)
(*      ||A||         http://helm.cs.unibo.it                             *)
(*      \   /                                                             *)
(*       \ /        This file is distributed under the terms of the       *)
(*        v         GNU General Public License Version 2                  *)
(*                                                                        *)
(**************************************************************************)

include "basic_2/substitution/cofrees_lift.ma".
include "basic_2/substitution/llpx_sn_alt1.ma".

(* LAZY SN POINTWISE EXTENSION OF A CONTEXT-SENSITIVE REALTION FOR TERMS ****)

(* alternative definition of llpx_sn (not recursive) *)
definition llpx_sn_alt2: relation4 bind2 lenv term term â†’ relation4 ynat term lenv lenv â‰
                         Î»R,d,T,L1,L2. |L1| = |L2| âˆ§
                         (âˆ€I1,I2,K1,K2,V1,V2,i. d â‰¤ yinj i â†’ (L1 âŠ¢ i ~Ïµ ğ…*[d]â¦ƒTâ¦„ â†’ âŠ¥) â†’
                            â‡©[i] L1 â‰¡ K1.â“‘{I1}V1 â†’ â‡©[i] L2 â‰¡ K2.â“‘{I2}V2 â†’
                            I1 = I2 âˆ§ R I1 K1 V1 V2
                         ).

(* Main properties **********************************************************)

lemma cpy_inv_nlift2_be: âˆ€G,L,U1,U2,d. â¦ƒG, Lâ¦„ âŠ¢ U1 â–¶[d, âˆ] U2 â†’ âˆ€i. d â‰¤ yinj i â†’
                         âˆ€K,s. â‡©[s, i, 1] L â‰¡ K â†’
                         (âˆ€T2. â‡§[i, 1] T2 â‰¡ U2 â†’ âŠ¥) â†’ (âˆ€T1. â‡§[i, 1] T1 â‰¡ U1 â†’ âŠ¥).
#G #L #U1 #U2 #d #HU12 #i #Hdi #K #s #HLK #HnU2 #T1 #HTU1
elim (cpy_inv_lift1_be â€¦ HU12 â€¦ HLK â€¦ HTU1) /2 width=2 by/
qed-.

lemma cpy_inv_nlift2_ge: âˆ€G,L,U1,U2,d,e. â¦ƒG, Lâ¦„ âŠ¢ U1 â–¶[d, e] U2 â†’
                         âˆ€i. d â‰¤ yinj i â†’ (* yinj i + yinj 1 â‰¤ d + e â†’ *)
                         (âˆ€T2. â‡§[i, 1] T2 â‰¡ U2 â†’ âŠ¥) â†’
                         âˆƒâˆƒj. d â‰¤ yinj j & j â‰¤ i & (âˆ€T1. â‡§[j, 1] T1 â‰¡ U1 â†’ âŠ¥).
#G #L #U1 #U2 #d #e #H elim H -G -L -U1 -U2 -d -e
[ #I #G #L #d #e #i #Hdi (* #Hide *) #H @(ex3_intro â€¦ i) /2 width=2 by/
| #I #G #L #K #V #W #j #d #e #Hdj #Hjde #HLK #HVW #i #Hdi (* #Hide *) #HnW
  elim (le_or_ge i j) #Hij [2: @(ex3_intro â€¦ j) /2 width=7 by lift_inv_lref2_be/ ]
  elim (lift_split â€¦ HVW i j) -HVW //
  #X #_ #H elim HnW -HnW //
| #a #I #G #L #W1 #W2 #U1 #U2 #d #e #_ #_ #IHW12 #IHU12 #i #Hdi #H elim (nlift_inv_bind â€¦ H) -H
  [ #HnW2 elim (IHW12 â€¦ HnW2) -IHW12 -HnW2 -IHU12 //
    #j #Hdj #Hji #HnW1 @(ex3_intro â€¦ j) /3 width=9 by nlift_bind_sn/
  | #HnU2 elim (IHU12 â€¦ HnU2) -IHU12 -HnU2 -IHW12 /2 width=1 by yle_succ/
    #j #Hdj #Hji
    >(plus_minus_m_m j 1) in âŠ¢ (%â†’?); [2: /3 width=3 by yle_trans, yle_inv_inj/ ]
    #HnW1 @(ex3_intro â€¦ (j-1)) /3 width=9 by nlift_bind_dx, yle_pred, monotonic_pred/
  ]
| #I #G #L #W1 #W2 #U1 #U2 #d #e #_ #_ #IHW12 #IHU12 #i #Hdi #H elim (nlift_inv_flat â€¦ H) -H
  [ #HnW2 elim (IHW12 â€¦ HnW2) -IHW12 -HnW2 -IHU12 //
    #j #Hdj #Hji #HnW1 @(ex3_intro â€¦ j) /3 width=8 by nlift_flat_sn/
  | #HnU2 elim (IHU12 â€¦ HnU2) -IHU12 -HnU2 -IHW12 //
    #j #Hdj #Hji #HnW1 @(ex3_intro â€¦ j) /3 width=8 by nlift_flat_dx/
  ]
]
qed-.

axiom frees_fwd_nlift_ge: âˆ€L,U,d,i. (L âŠ¢ i ~Ïµ ğ…*[d]â¦ƒUâ¦„ â†’ âŠ¥) â†’ d â‰¤ yinj i â†’
                          âˆƒâˆƒj. d â‰¤ yinj j & j â‰¤ i & (âˆ€T. â‡§[j, 1] T â‰¡ U â†’ âŠ¥).

(*
lemma frees_ind_nlift: âˆ€L,d. âˆ€R:relation2 term nat.
                       (âˆ€U1,i. d â‰¤ yinj i â†’ (âˆ€T1. â‡§[i, 1] T1 â‰¡ U1 â†’ âŠ¥) â†’ R U1 i) â†’
                       (âˆ€U1,U2,i,j. d â‰¤ yinj j â†’ j â‰¤ i â†’ â¦ƒâ‹†, Lâ¦„ âŠ¢ U1 â–¶[d, âˆ] U2 â†’ (âˆ€T2. â‡§[i, 1] T2 â‰¡ U2 â†’ âŠ¥) â†’ R U2 i â†’ R U1 j) â†’
                       âˆ€U,i. d â‰¤ yinj i â†’ (L âŠ¢ i ~Ïµ ğ…*[d]â¦ƒUâ¦„ â†’ âŠ¥) â†’ R U i.
#L #d #R #IH1 #IH2 #U1 #i #Hdi #H @(frees_ind â€¦ H) -U1 /3 width=4 by/
#U1 #U2 #HU12 #HnU2 #HU2 @(IH2 â€¦ HU12 â€¦ HU2)

qed-.
*)(*
lemma frees_fwd_nlift: âˆ€L,d. âˆ€R:relation2 term nat. (
                          âˆ€U1,j. (âˆ€T1. â‡§[j, 1] T1 â‰¡ U1 â†’ âŠ¥) âˆ¨ 
                                 (âˆƒâˆƒU2,i. d â‰¤ yinj j â†’ j < i & (L âŠ¢ j ~Ïµ ğ…*[d]â¦ƒU1â¦„ â†’ âŠ¥) & â¦ƒâ‹†, Lâ¦„ âŠ¢ U1 â–¶[d, âˆ] U2 & R U1 i
                                 ) â†’  
                          d â‰¤ yinj j â†’ R U1 j
                       ) â†’
                       âˆ€U,i. d â‰¤ yinj i â†’ (L âŠ¢ i ~Ïµ ğ…*[d]â¦ƒUâ¦„ â†’ âŠ¥) â†’ R U i.
#L #d #R #IHR #U1 #j #Hdj #H elim (frees_inv_gen â€¦ H) -H
#U2 #H generalize in match Hdj; -Hdj generalize in match j; -j @(cpys_ind â€¦ H) -U2
[ #j #Hdj #HnU1 @IHR -IHR /3 width=2 by or_introl/
| #U0 #U2 #HU10 #HU02 #IHU10 #j #Hdj #HnU2 elim (cpy_inv_nlift2_ge â€¦ HU02 â€¦ Hdj HnU2) -HU02 -HnU2
  #i #Hdi #Hij #HnU0 lapply (IHU10 â€¦ HnU0) // -IHU10
  #Hi @IHR -IHR // -Hdj @or_intror  

lemma frees_fwd_nlift: âˆ€L,U,d,i. d â‰¤ yinj i â†’ (L âŠ¢ i ~Ïµ ğ…*[d]â¦ƒUâ¦„ â†’ âŠ¥) â†’
                       âˆƒâˆƒj. d â‰¤ yinj j & j â‰¤ i & (âˆ€T. â‡§[j, 1] T â‰¡ U â†’ âŠ¥).
#L #U1 #d #i #Hdi  #H 
#U2 #H #HnU2 @(cpys_ind_dx â€¦ H) -U1 [ @(ex3_intro â€¦ i) /2 width=2 by/ ] -Hdi -HnU2
#U1 #U0 #HU10 #_ * #j #Hdj #Hji #HnU0 elim (cpy_inv_nlift2_ge â€¦ HU10 â€¦ Hdj HnU0) -U0 -Hdj
/3 width=5 by transitive_le, ex3_intro/
qed-.
*)

theorem llpx_sn_llpx_sn_alt2: âˆ€R,L1,L2,T,d. llpx_sn R d T L1 L2 â†’ llpx_sn_alt2 R d T L1 L2.
#R #L1 #L2 #U1 #d #H elim (llpx_sn_inv_alt1 â€¦ H) -H
#HL12 #IH @conj // -HL12
#I1 #I2 #K1 #K2 #V1 #V2 #i #Hdi #H #HLK1 #HLK2
elim (frees_fwd_nlift_ge â€¦ H Hdi) -H -Hdi #j #Hdj #Hji #HnU1
lapply (ldrop_fwd_length_lt2 â€¦ HLK1) #HL1
lapply (ldrop_fwd_length_lt2 â€¦ HLK2) #HL2
lapply (le_to_lt_to_lt â€¦ Hji HL1) -HL1 #HL1
lapply (le_to_lt_to_lt â€¦ Hji HL2) -HL2 #HL2
elim (ldrop_O1_lt L1 j) // #Z1 #Y1 #X1 #HLY1
elim (ldrop_O1_lt L2 j) // #Z2 #Y2 #X2 #HLY2




generalize in match V2; -V2 generalize in match V1; -V1
generalize in match K2; -K2 generalize in match K1; -K1
generalize in match I2; -I2 generalize in match I1; -I1
generalize in match IH; -IH
@(frees_ind_nlift â€¦ Hdi H) -U1 -i
[ #U1 #i #Hdi #HnU1 #IH #I1 #I2 #K1 #K2 #V1 #V2 #HLK1 #HLK2 elim (IH â€¦ HnU1 HLK1 HLK2) -IH -HnU1 -HLK1 -HLK2 /2 width=1 by conj/
| #U1 #U2 #i #j #Hdj #Hji #HU12 #HnU2 #IHU12 #IH #I1 #I2 #K1 #K2 #V1 #V2 #HLK1 #HLK2
(*  
*)
  @(IHU12) â€¦ HLK1 HLK2)
  
  @(IHU12 â€¦ HLK1 HLK2) -IHU02 -I1 -I2 -K1 -K2 -V1 -V2
  #I1 #I2 #K1 #K2 #V1 #V2 #j #Hdj #HnU0 #HLK1 #HLK2 @(IH â€¦ HLK1 HLK2) -IH -HLK1 -HLK2 //



 elim (frees_fwd_nlift â€¦ HnU1) // -HnU1 -Hdi
#j #Hdj #Hji #HnU1 
lapply (ldrop_fwd_length_lt2 â€¦ HLK1) #HL1
lapply (ldrop_fwd_length_lt2 â€¦ HLK2) #HL2
lapply (le_to_lt_to_lt â€¦ Hji HL1) -HL1 #HL1
lapply (le_to_lt_to_lt â€¦ Hji HL2) -HL2 #HL2
elim (ldrop_O1_lt L1 j) // #Z1 #Y1 #X1 #HLY1 
elim (ldrop_O1_lt L2 j) // #Z2 #Y2 #X2 #HLY2
elim (IH â€¦ HnU1 HLY1 HLY2) // #H #HX12 #HY12 destruct 






















theorem llpx_sn_llpx_sn_alt2: âˆ€R,L1,L2,T,d. llpx_sn R d T L1 L2 â†’ llpx_sn_alt2 R d T L1 L2.
#R #L1 #L2 #U1 #d #H @(llpx_sn_ind_alt1 â€¦ H) -L1 -L2 -U1 -d
#L1 #L2 #U1 #d #HL12 #IH @conj // -HL12
#I1 #I2 #K1 #K2 #V1 #V2 #i #Hdi #HnU1 #HLK1 #HLK2 elim (frees_inv_gen â€¦ HnU1) -HnU1
#U2 #H generalize in match IH; -IH @(cpys_ind_dx â€¦ H) -U1
[ #IH #HnU2 elim (IH â€¦ HnU2 â€¦ HLK1 HLK2) -L1 -L2 -U2 /2 width=1 by conj/
| #U1 #U0 #HU10 #_ #IHU02 #IH #HnU2 @IHU02 /2 width=2 by/ -I1 -I2 -K1 -K2 -V1 -V2 -U2 -i
  #I1 #I2 #K1 #K2 #V1 #V2 #i #Hdi #HnU0 #HLK1 #HLK2 @(IH â€¦ HLK1 HLK2) -IH // -R -I2 -L2 -K2 -V2
  @(cpy_inv_nlift2_be â€¦ HU10) /2 width=3 by/   

theorem llpx_sn_llpx_sn_alt2: âˆ€R,L1,L2,T2,d. llpx_sn R d T2 L1 L2 â†’
                              âˆ€T1. â¦ƒâ‹†, L1â¦„ âŠ¢ T1 â–¶*[d, âˆ] T2 â†’ llpx_sn_alt2 R d T1 L1 L2.
#R #L1 #L2 #U2 #d #H elim (llpx_sn_inv_alt1 â€¦ H) -H
#HL12 #IH #U1 #HU12 @conj // -HL12
#I1 #I2 #K1 #K2 #V1 #V2 #i #Hdi #HnU1 #HLK1 #HLK2 elim (frees_inv_gen â€¦ HnU1) -HnU1
#U2 #H generalize in match IH; -IH @(cpys_ind_dx â€¦ H) -U1
[ #IH #HnU2 elim (IH â€¦ HnU2 â€¦ HLK1 HLK2) -L1 -L2 -U2 /2 width=1 by conj/
| #U1 #U0 #HU10 #_ #IHU02 #IH #HnU2 @IHU02 /2 width=2 by/ -I1 -I2 -K1 -K2 -V1 -V2 -U2 -i
  #I1 #I2 #K1 #K2 #V1 #V2 #i #Hdi #HnU0 #HLK1 #HLK2 @(IH â€¦ HLK1 HLK2) -IH // -R -I2 -L2 -K2 -V2
  @(cpy_inv_nlift2_be â€¦ HU10) /2 width=3 by/   


theorem llpx_sn_llpx_sn_alt2: âˆ€R,L1,L2,T,d. llpx_sn R d T L1 L2 â†’ llpx_sn_alt2 R d T L1 L2.
#R #L1 #L2 #U1 #d #H elim (llpx_sn_inv_alt1 â€¦ H) -H
#HL12 #IH @conj // -HL12
#I1 #I2 #K1 #K2 #V1 #V2 #i #Hdi #HnU1 #HLK1 #HLK2 elim (frees_inv_gen â€¦ HnU1) -HnU1
#U2 #H generalize in match IH; -IH @(cpys_ind_dx â€¦ H) -U1
[ #IH #HnU2 elim (IH â€¦ HnU2 â€¦ HLK1 HLK2) -L1 -L2 -U2 /2 width=1 by conj/
| #U1 #U0 #HU10 #_ #IHU02 #IH #HnU2 @IHU02 /2 width=2 by/ -I1 -I2 -K1 -K2 -V1 -V2 -U2 -i
  #I1 #I2 #K1 #K2 #V1 #V2 #i #Hdi #HnU0 #HLK1 #HLK2 @(IH â€¦ HLK1 HLK2) -IH // -R -I2 -L2 -K2 -V2
  @(cpy_inv_nlift2_be â€¦ HU10) /2 width=3 by/   
