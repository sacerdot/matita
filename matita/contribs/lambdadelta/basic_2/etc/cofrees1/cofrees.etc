(**************************************************************************)
(*       ___                                                              *)
(*      ||M||                                                             *)
(*      ||A||       A project by Andrea Asperti                           *)
(*      ||T||                                                             *)
(*      ||I||       Developers:                                           *)
(*      ||T||         The HELM team.                                      *)
(*      ||A||         http://helm.cs.unibo.it                             *)
(*      \   /                                                             *)
(*       \ /        This file is distributed under the terms of the       *)
(*        v         GNU General Public License Version 2                  *)
(*                                                                        *)
(**************************************************************************)

include "basic_2/notation/relations/cofreestar_4.ma".
include "basic_2/relocation/lift_neg.ma".
include "basic_2/substitution/cpys.ma".

(* CONTEXT-SENSITIVE EXCLUSION FROM FREE VARIABLES **************************)

definition cofrees: relation4 ynat nat lenv term â‰
                    Î»d,i,L,U1. âˆ€U2. â¦ƒâ‹†, Lâ¦„ âŠ¢ U1 â–¶*[d, âˆ] U2 â†’ âˆƒT2. â‡§[i, 1] T2 â‰¡ U2.

interpretation
   "context-sensitive exclusion from free variables (term)"
   'CoFreeStar L i d T = (cofrees d i L T).

(* Basic forward lemmas *****************************************************)

lemma cofrees_fwd_lift: âˆ€L,U,d,i. L âŠ¢ i ~Ïµ ğ…*[d]â¦ƒUâ¦„ â†’ âˆƒT. â‡§[i, 1] T â‰¡ U.
/2 width=1 by/ qed-.

lemma cofrees_fwd_bind_sn: âˆ€a,I,L,W,U,i,d. L âŠ¢ i ~Ïµ ğ…*[d]â¦ƒâ“‘{a,I}W.Uâ¦„ â†’
                           L âŠ¢ i ~Ïµ ğ…*[d]â¦ƒWâ¦„.
#a #I #L #W1 #U #i #d #H #W2 #HW12 elim (H (â“‘{a,I}W2.U)) /2 width=1 by cpys_bind/ -W1
#X #H elim (lift_inv_bind2 â€¦ H) -H /2 width=2 by ex_intro/
qed-.

lemma cofrees_fwd_bind_dx: âˆ€a,I,L,W,U,i,d. L âŠ¢ i ~Ïµ ğ…*[d]â¦ƒâ“‘{a,I}W.Uâ¦„ â†’
                           L.â“‘{I}W âŠ¢ i+1 ~Ïµ ğ…*[â«¯d]â¦ƒUâ¦„.
#a #I #L #W #U1 #i #d #H #U2 #HU12 elim (H (â“‘{a,I}W.U2)) /2 width=1 by cpys_bind/ -U1
#X #H elim (lift_inv_bind2 â€¦ H) -H /2 width=2 by ex_intro/
qed-.

lemma cofrees_fwd_flat_sn: âˆ€I,L,W,U,i,d. L âŠ¢ i ~Ïµ ğ…*[d]â¦ƒâ“•{I}W.Uâ¦„ â†’
                           L âŠ¢ i ~Ïµ ğ…*[d]â¦ƒWâ¦„.
#I #L #W1 #U #i #d #H #W2 #HW12 elim (H (â“•{I}W2.U)) /2 width=1 by cpys_flat/ -W1
#X #H elim (lift_inv_flat2 â€¦ H) -H /2 width=2 by ex_intro/
qed-.

lemma cofrees_fwd_flat_dx: âˆ€I,L,W,U,i,d. L âŠ¢ i ~Ïµ ğ…*[d]â¦ƒâ“•{I}W.Uâ¦„ â†’
                           L âŠ¢ i ~Ïµ ğ…*[d]â¦ƒUâ¦„.
#I #L #W #U1 #i #d #H #U2 #HU12 elim (H (â“•{I}W.U2)) /2 width=1 by cpys_flat/ -U1
#X #H elim (lift_inv_flat2 â€¦ H) -H /2 width=2 by ex_intro/
qed-.

(* Basic inversion lemmas ***************************************************)

lemma cofrees_inv_gen: âˆ€L,U,U0,d,i. â¦ƒâ‹†, Lâ¦„ âŠ¢ U â–¶*[d, âˆ] U0 â†’ (âˆ€T. â‡§[i, 1] T â‰¡ U0 â†’ âŠ¥) â†’
                       L âŠ¢ i ~Ïµ ğ…*[d]â¦ƒUâ¦„ â†’ âŠ¥.
#L #U #U0 #d #i #HU0 #HnU0 #HU elim (HU â€¦ HU0) -L -U -d /2 width=2 by/
qed-.

lemma cofrees_inv_lref_eq: âˆ€L,d,i. L âŠ¢ i ~Ïµ ğ…*[d]â¦ƒ#iâ¦„ â†’ âŠ¥.
#L #d #i #H elim (H (#i)) -H //
#X #H elim (lift_inv_lref2_be â€¦ H) -H //
qed-. 

lemma cofrees_inv_bind: âˆ€a,I,L,W,U,i,d. L âŠ¢ i ~Ïµ ğ…*[d]â¦ƒâ“‘{a,I}W.Uâ¦„ â†’
                        L âŠ¢ i ~Ïµ ğ…*[d]â¦ƒWâ¦„ âˆ§ L.â“‘{I}W âŠ¢ i+1 ~Ïµ ğ…*[â«¯d]â¦ƒUâ¦„.
/3 width=8 by cofrees_fwd_bind_sn, cofrees_fwd_bind_dx, conj/ qed-.

lemma cofrees_inv_flat: âˆ€I,L,W,U,i,d. L âŠ¢ i ~Ïµ ğ…*[d]â¦ƒâ“•{I}W.Uâ¦„ â†’
                        L âŠ¢ i ~Ïµ ğ…*[d]â¦ƒWâ¦„ âˆ§ L âŠ¢ i ~Ïµ ğ…*[d]â¦ƒUâ¦„.
/3 width=7 by cofrees_fwd_flat_sn, cofrees_fwd_flat_dx, conj/ qed-.

(* Basic Properties *********************************************************)

lemma cofrees_lsuby_conf: âˆ€L1,U,d,i. L1 âŠ¢ i ~Ïµ ğ…*[d]â¦ƒUâ¦„ â†’
                          âˆ€L2. L1 âŠ†[d, âˆ] L2 â†’ L2 âŠ¢ i ~Ïµ ğ…*[d]â¦ƒUâ¦„.
/3 width=3 by lsuby_cpys_trans/ qed-.

lemma cofrees_sort: âˆ€L,d,i,k. L âŠ¢ i ~Ïµ ğ…*[d]â¦ƒâ‹†kâ¦„.
#L #d #i #k #X #H >(cpys_inv_sort1 â€¦ H) -X /2 width=2 by ex_intro/
qed.

lemma cofrees_gref: âˆ€L,d,i,p. L âŠ¢ i ~Ïµ ğ…*[d]â¦ƒÂ§pâ¦„.
#L #d #i #p #X #H >(cpys_inv_gref1 â€¦ H) -X /2 width=2 by ex_intro/
qed.

lemma cofrees_bind: âˆ€L,V,d,i. L âŠ¢ i ~Ïµ ğ…*[d] â¦ƒVâ¦„ â†’
                    âˆ€I,T. L.â“‘{I}V âŠ¢ i+1 ~Ïµ ğ…*[â«¯d]â¦ƒTâ¦„ â†’
                    âˆ€a. L âŠ¢ i ~Ïµ ğ…*[d]â¦ƒâ“‘{a,I}V.Tâ¦„.
#L #W1 #d #i #HW1 #I #U1 #HU1 #a #X #H elim (cpys_inv_bind1 â€¦ H) -H
#W2 #U2 #HW12 #HU12 #H destruct
elim (HW1 â€¦ HW12) elim (HU1 â€¦ HU12) -W1 -U1 /3 width=2 by lift_bind, ex_intro/
qed.

lemma cofrees_flat: âˆ€L,V,d,i. L âŠ¢ i ~Ïµ ğ…*[d]â¦ƒVâ¦„ â†’ âˆ€T. L âŠ¢ i ~Ïµ ğ…*[d]â¦ƒTâ¦„ â†’
                    âˆ€I. L âŠ¢ i ~Ïµ ğ…*[d]â¦ƒâ“•{I}V.Tâ¦„.
#L #W1 #d #i #HW1 #U1 #HU1 #I #X #H elim (cpys_inv_flat1 â€¦ H) -H
#W2 #U2 #HW12 #HU12 #H destruct
elim (HW1 â€¦ HW12) elim (HU1 â€¦ HU12) -W1 -U1 /3 width=2 by lift_flat, ex_intro/
qed.

lemma cofrees_cpy_trans: âˆ€L,U1,U2,d. â¦ƒâ‹†, Lâ¦„ âŠ¢ U1 â–¶[d, âˆ] U2 â†’
                         âˆ€i. L âŠ¢ i ~Ïµ ğ…*[d]â¦ƒU1â¦„ â†’ L âŠ¢ i ~Ïµ ğ…*[d]â¦ƒU2â¦„.
/3 width=3 by cpys_strap2/ qed-.

axiom cofrees_dec: âˆ€L,T,d,i. Decidable (L âŠ¢ i ~Ïµ ğ…*[d]â¦ƒTâ¦„).

(* Basic negated properties *************************************************)

lemma frees_cpy_div: âˆ€L,U1,U2,d. â¦ƒâ‹†, Lâ¦„ âŠ¢ U1 â–¶[d, âˆ] U2 â†’
                     âˆ€i. (L âŠ¢ i ~Ïµ ğ…*[d]â¦ƒU2â¦„ â†’ âŠ¥) â†’ (L âŠ¢ i ~Ïµ ğ…*[d]â¦ƒU1â¦„ â†’ âŠ¥).
/3 width=7 by cofrees_cpy_trans/ qed-.

(* Basic negated inversion lemmas *******************************************)

lemma frees_inv_bind: âˆ€a,I,L,V,T,d,i. (L âŠ¢ i ~Ïµ ğ…*[d]â¦ƒâ“‘{a,I}V.Tâ¦„ â†’ âŠ¥) â†’
                      (L âŠ¢ i ~Ïµ ğ…*[d]â¦ƒVâ¦„ â†’ âŠ¥) âˆ¨ (L.â“‘{I}V âŠ¢ i+1 ~Ïµ ğ…*[â«¯d]â¦ƒTâ¦„ â†’ âŠ¥).
#a #I #L #W #U #d #i #H elim (cofrees_dec L W d i)
/4 width=9 by cofrees_bind, or_intror, or_introl/
qed-.

lemma frees_inv_flat: âˆ€I,L,V,T,d,i. (L âŠ¢ i ~Ïµ ğ…*[d]â¦ƒâ“•{I}V.Tâ¦„ â†’ âŠ¥) â†’
                      (L âŠ¢ i ~Ïµ ğ…*[d]â¦ƒVâ¦„ â†’ âŠ¥) âˆ¨ (L âŠ¢ i ~Ïµ ğ…*[d]â¦ƒTâ¦„ â†’ âŠ¥).
#I #L #W #U #d #H elim (cofrees_dec L W d)
/4 width=8 by cofrees_flat, or_intror, or_introl/
qed-.
