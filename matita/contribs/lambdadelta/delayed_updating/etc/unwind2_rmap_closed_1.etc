include "ground/arith/nat_le_plus.ma".
include "ground/arith/nat_le_pred.ma".

lemma tls_succ_unwind2_rmap_append_closed_Lq_dx (o) (f) (p) (q) (n):
      q Ïµ ğ‚â¨o,nâ© â†’
      â–¶[f]p â‰— â‡‚*[â†‘n]â–¶[f](pâ—ğ—Ÿâ——q).
/2 width=2 by tls_succ_plus_unwind2_rmap_push_closed/
qed-.

lemma xap_le_unwind2_rmap_append_closed_dx (o) (f) (p) (q) (n):
      q Ïµ ğ‚â¨o,nâ© â†’ âˆ€m. m â‰¤ n â†’
      â–¶[f]qï¼ â¨mâ© = â–¶[f](pâ—q)ï¼ â¨mâ©.
#o #f #p #q #n #Hq elim Hq -q -n
[|*: #q #n [ #k #_ ] #_ #IH ] #m #Hm
[ <(nle_inv_zero_dx â€¦ Hm) -m //
| <unwind2_rmap_d_dx <unwind2_rmap_d_dx
  <tr_compose_xap <tr_compose_xap
  @IH -IH (**) (* auto too slow *)
  @nle_trans [| @tr_uni_xap ]
  /2 width=1 by nle_plus_bi_dx/
| <unwind2_rmap_m_dx <unwind2_rmap_m_dx
  /2 width=2 by/
| <unwind2_rmap_L_dx <unwind2_rmap_L_dx
  elim (nle_inv_succ_dx â€¦ Hm) -Hm // * #Hm #H0
  >H0 -H0 <tr_xap_push <tr_xap_push
  /3 width=2 by eq_f/
| <unwind2_rmap_A_dx <unwind2_rmap_A_dx
  /2 width=2 by/
| <unwind2_rmap_S_dx <unwind2_rmap_S_dx
  /2 width=2 by/
]
qed-.

lemma nap_unwind2_rmap_append_closed_Lq_dx (o) (f) (p) (q) (n):
      q Ïµ ğ‚â¨o,nâ© â†’
      â–¶[f](ğ—Ÿâ——q)ï¼ Â§â¨nâ© = â–¶[f](pâ—ğ—Ÿâ——q)ï¼ Â§â¨nâ©.
#o #f #p #q #n #Hq
lapply (pcc_L_sn â€¦ Hq) -Hq #Hq
lapply (xap_le_unwind2_rmap_append_closed_dx o f p â€¦ Hq (â†‘n) ?) -Hq //
<tr_xap_succ_nap <tr_xap_succ_nap #Hq
/2 width=1 by eq_inv_nsucc_bi/
qed-.

lemma nap_unwind2_rmap_push_closed_depth (o) (f) (q) (n):
      q Ïµ ğ‚â¨o,nâ© â†’
      â™­q = â–¶[â«¯f]qï¼ Â§â¨nâ©.
#o #f #q #n #Hq elim Hq -q -n
[|*: #q #n [ #k #_ ] #_ #IH ] //
<unwind2_rmap_d_dx <tr_compose_nap //
qed-.

lemma nap_unwind2_rmap_append_closed_Lq_dx_depth (o) (f) (p) (q) (n):
      q Ïµ ğ‚â¨o,nâ© â†’
      â™­q = â–¶[f](pâ—ğ—Ÿâ——q)ï¼ Â§â¨nâ©.
#o #f #p #q #n #Hq
<nap_unwind2_rmap_append_closed_Lq_dx //
/2 width=2 by nap_unwind2_rmap_push_closed_depth/
qed-.

lemma xap_unwind2_rmap_append_closed_true_dx_depth (f) (p) (q) (n):
      q Ïµ ğ‚â¨â“‰,nâ© â†’ â™­q = â–¶[f](pâ—q)ï¼ â¨nâ©.
#f #p #q #n #Hq elim Hq -q -n //
#q #n #k #Ho #_ #IH
<unwind2_rmap_d_dx <tr_compose_xap
>Ho // <tr_uni_xap_succ <Ho //
qed-.

lemma tls_plus_unwind2_rmap_closed_true (f) (q) (n):
      q Ïµ ğ‚â¨â“‰,nâ© â†’
      âˆ€m. â‡‚*[m]f â‰— â‡‚*[m+n]â–¶[f]q.
#f #q #n #Hq elim Hq -q -n //
#q #n #k #Ho #_ #IH #m
>Ho // <nplus_succ_dx
@(stream_eq_trans â€¦ (tls_unwind2_rmap_d_dx â€¦))
>nrplus_inj_dx >nrplus_inj_sn >nsucc_unfold
>nplus_succ_dx <Ho //
qed-.

lemma tls_unwind2_rmap_append_closed_true_dx (f) (p) (q) (n):
      q Ïµ ğ‚â¨â“‰,nâ© â†’
      â–¶[f]p â‰— â‡‚*[n]â–¶[f](pâ—q).
/2 width=1 by tls_plus_unwind2_rmap_closed_true/
qed-.

lemma nap_plus_unwind2_rmap_append_closed_Lq_dx_depth (o) (f) (p) (q) (m) (n):
      q Ïµ ğ‚â¨o,nâ© â†’
      â–¶[f]pï¼ â¨mâ©+â™­q = â–¶[f](pâ—ğ—Ÿâ——q)ï¼ Â§â¨m+nâ©.
#o #f #p #q #m #n #Hq
<tr_nap_plus @eq_f2
[ <(tr_xap_eq_repl â€¦ (tls_succ_unwind2_rmap_append_closed_Lq_dx â€¦)) //
| /2 width=2 by nap_unwind2_rmap_append_closed_Lq_dx_depth/
]
qed-.

lemma nap_plus_unwind2_rmap_append_closed_bLq_dx_depth (o) (f) (p) (b) (q) (m) (n):
      b Ïµ ğ‚â¨â“‰,mâ© â†’ q Ïµ ğ‚â¨o,nâ© â†’
      â™­b+â™­q = â–¶[f](pâ—bâ—ğ—Ÿâ——q)ï¼ Â§â¨m+nâ©.
#o #f #p #b #q #m #n #Hb #Hq
>(xap_unwind2_rmap_append_closed_true_dx_depth f p â€¦ Hb) -Hb
>(nap_plus_unwind2_rmap_append_closed_Lq_dx_depth â€¦ Hq) -Hq //
qed-.

lemma tls_succ_plus_unwind2_rmap_append_closed_bLq_dx (o) (f) (p) (b) (q) (m) (n):
      b Ïµ ğ‚â¨â“‰,mâ© â†’ q Ïµ ğ‚â¨o,nâ© â†’
      â–¶[f]p â‰— â‡‚*[â†‘(m+n)]â–¶[f](pâ—bâ—ğ—Ÿâ——q).
#o #f #p #b #q #m #n #Hb #Hq
>nplus_succ_dx <stream_tls_plus >list_append_assoc
@(stream_eq_trans â€¦ (tls_unwind2_rmap_append_closed_true_dx â€¦ Hb)) -Hb
/3 width=2 by stream_tls_eq_repl, tls_succ_unwind2_rmap_append_closed_Lq_dx/
qed-.
